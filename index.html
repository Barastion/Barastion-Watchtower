<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Odwiedzin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Monitor Odwiedzin</h1>
        <table id="logTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Godzina</th>
                </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
        </table>
    </div>

    <script>
        // Pobierz i wyświetl logi przy załadowaniu strony
        window.onload = function() {
            logVisit();
            displayLogs();
        };

        // Funkcja zapisująca wizytę
        function logVisit() {
            const now = new Date();
            const date = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const time = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            const logEntry = { date, time };

            let logs = JSON.parse(localStorage.getItem('visitLogs')) || [];
            logs.unshift(logEntry); // Nowe logi na górze
            if (logs.length > 100) logs.pop(); // Usuwamy najstarszy log (ostatni)
            localStorage.setItem('visitLogs', JSON.stringify(logs));
            displayLogs();
        }

        // Funkcja wyświetlająca logi w tabeli
        function displayLogs() {
            const logs = JSON.parse(localStorage.getItem('visitLogs')) || [];
            const logTableBody = document.getElementById('logTableBody');
            if (!logTableBody) {
                console.error('Element logTableBody nie istnieje w DOM');
                return;
            }
            logTableBody.innerHTML = '';
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.date || 'Nieznana'}</td>
                    <td>${log.time || 'Nieznana'}</td>
                `;
                logTableBody.appendChild(row);
            });
        }

        // Ochrona przed DDoS – zapisujemy logi tylko raz na minutę z tego samego IP
        let lastIpLogTime = {};
        async function checkDDoSProtection(callback) {
            const ip = await getIp();
            const currentTime = Date.now();
            if (lastIpLogTime[ip]) {
                const timeDiff = (currentTime - lastIpLogTime[ip]) / 1000 / 60; // W minutach
                if (timeDiff < 1) {
                    console.log('Ograniczenie logowania – zbyt częste z tego samego IP');
                    return false; // Nie zapisujemy, jeśli minęła mniej niż minuta
                }
            }
            lastIpLogTime[ip] = currentTime;
            callback();
            return true;
        }

        // Pobierz IP użytkownika
        async function getIp() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'Nieznany IP';
            } catch (err) {
                console.error('Błąd pobierania IP:', err);
                return 'Nieznany IP';
            }
        }

        // Inicjalizacja przy załadowaniu strony z ochroną DDoS
        window.onload = function() {
            checkDDoSProtection(logVisit);
            displayLogs();
        };
    </script>
</body>
</html>
