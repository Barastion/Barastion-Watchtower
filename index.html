<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Odwiedzin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Monitor Odwiedzin</h1>
        <table id="logTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Dzień tygodnia</th>
                    <th>Godzina</th>
                    <th>IP</th>
                    <th>Lokalizacja (Miasto/Kraj)</th>
                    <th>User Agent</th>
                    <th>Przeglądarka</th>
                </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
        </table>
        <button onclick="exportLogs()">Eksportuj logi</button>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const CLIENT_ID = '183075047643-uo1onbpgq7ebpru4br02o87a4fjhjssc.apps.googleusercontent.com';
        const API_KEY = '';
        const FILE_ID = '1h720TRMofpJ0G6VXFg-H6j5XL3GKGhx8nPl-IZFrbR8';  // Poprawiony prawidłowy File ID
        const SCOPE = 'https://www.googleapis.com/auth/drive.file';

        let token = null;

        function initGoogleAPI() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    clientId: CLIENT_ID,
                    scope: SCOPE,
                }).then(() => {
                    const authInstance = gapi.auth2.getAuthInstance();
                    authInstance.isSignedIn.listen(updateSigninStatus);
                    updateSigninStatus(authInstance.isSignedIn.get());
                });
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                logVisit();
            } else {
                gapi.auth2.getAuthInstance().signIn();
            }
        }

        async function getLocation(ip) {
            try {
                const response = await axios.get(`https://ipapi.co/${ip}/json/`);
                return `${response.data.city || 'Nieznane'}/${response.data.country_name || 'Nieznany'}`;
            } catch (err) {
                return 'Nieznane/Nieznany';
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${FILE_ID}?alt=media`, {
                    headers: { Authorization: `Bearer ${token}` },
                });
                const text = await response.text();
                return text.split('\n').filter(line => line.trim() !== '').map(line => JSON.parse(line));
            } catch (error) {
                console.error('Błąd pobierania logów:', error);
                return [];
            }
        }

        async function saveLogs(logs) {
            const boundary = '-------314159265358979323846';
            const delimiter = `\r\n--${boundary}\r\n`;
            const closeDelim = `\r\n--${boundary}--`;
            const contentType = 'text/plain';
            const metadata = { name: 'logs.txt', mimeType: contentType };
            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                `Content-Type: ${contentType}\r\n\r\n` +
                logs.map(JSON.stringify).join('\n') +
                closeDelim;

            try {
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${FILE_ID}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: { Authorization: `Bearer ${token}` },
                    body: multipartRequestBody,
                });
            } catch (error) {
                console.error('Błąd zapisu logów:', error);
            }
        }

        async function logVisit() {
            try {
                const ip = await fetch('https://api.ipify.org?format=json')
                    .then(response => response.json())
                    .then(data => data.ip)
                    .catch(() => 'Nieznany IP');

                const userAgent = navigator.userAgent;
                const browser = (userAgent.match(/(Chrome|Firefox|Safari|Edge)/) || ['Inna'])[0];

                const now = new Date();
                const logEntry = {
                    date: now.toISOString().split('T')[0],
                    dayOfWeek: now.toLocaleDateString('pl-PL', { weekday: 'long' }),
                    time: now.toLocaleTimeString(),
                    ip: ip,
                    location: await getLocation(ip),
                    userAgent: userAgent,
                    browser: browser,
                };

                const logs = await fetchLogs();
                logs.push(logEntry);
                await saveLogs(logs);
                updateLogTable(logs);
            } catch (error) {
                console.error('Błąd logowania wizyty:', error);
            }
        }

        function updateLogTable(logs) {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.date}</td>
                    <td>${log.dayOfWeek}</td>
                    <td>${log.time}</td>
                    <td>${log.ip}</td>
                    <td>${log.location}</td>
                    <td>${log.userAgent}</td>
                    <td>${log.browser}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportLogs() {
            const logs = document.getElementById('logTableBody').innerHTML;
            const blob = new Blob([logs], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'logs.txt';
            a.click();
        }

        window.onload = function () {
            initGoogleAPI();
        };
    </script>
</body>
</html>
