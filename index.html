<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Odwiedzin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Monitor Odwiedzin</h1>
        <table id="logTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Godzina</th>
                    <th>IP</th>
                    <th>Przeglądarka</th>
                </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
        </table>
    </div>

    <script>
        const CLIENT_ID = '183075047643-uo1onbpgq7ebpru4br02o87a4fjhjssc.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAy8hRvI87HpyuO-eB791Ntnn7U_tmtrYU';
        const FILE_ID = '1h720TRMofpJ0G6VXFg-H6j5XL3GKGhx8nPl-IZFrbR8';
        const SCOPE = 'https://www.googleapis.com/auth/drive.file';

        let token = null;
        let lastIpLogTime = {}; // Obiekt do śledzenia ostatniego logowania dla każdego IP

        // Dynamiczne ładowanie skryptu Google API
        function loadGoogleApiScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = true;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Nie udało się załadować Google API'));
                document.head.appendChild(script);
            });
        }

        async function initGoogleAPI() {
            try {
                await loadGoogleApiScript();
                await new Promise(resolve => gapi.load('client:auth2', resolve));
                await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    scope: SCOPE,
                });
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            } catch (error) {
                console.error('Błąd inicjalizacji Google API:', error);
            }
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                console.log('Zalogowano pomyślnie, token:', token);
                logVisit();
            } else {
                console.log('Próba logowania...');
                gapi.auth2.getAuthInstance().signIn();
            }
        }

        async function getIp() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'Nieznany IP';
            } catch (err) {
                console.error('Błąd pobierania IP:', err);
                return 'Nieznany IP';
            }
        }

        function getBrowser() {
            const userAgent = navigator.userAgent;
            return userAgent.match(/(Chrome|Firefox|Safari|Edge)/) ? userAgent.match(/(Chrome|Firefox|Safari|Edge)/)[0].slice(0, 10) : 'Nieznana';
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${FILE_ID}?alt=media`, {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!response.ok) throw new Error('Błąd pobierania logów z Google Drive: ' + response.status);
                const text = await response.text();
                const lines = text.trim().split('\n').filter(line => line.trim() !== '');
                return lines.map(line => {
                    try {
                        return JSON.parse(line); // Próbujemy parsować jako JSON
                    } catch (e) {
                        // Jeśli nie można sparsować jako JSON, zakładamy, że to stary format tekstowy
                        const [date, time, ip, browser] = line.split(' | ');
                        return { date, time, ip, browser };
                    }
                });
            } catch (err) {
                console.error('Błąd fetchLogs:', err);
                return []; // Zwracamy pustą tablicę w przypadku błędu
            }
        }

        async function saveLogs(logs) {
            try {
                const boundary = '-------314159265358979323846';
                const delimiter = `\r\n--${boundary}\r\n`;
                const closeDelim = `\r\n--${boundary}--`;
                const contentType = 'text/plain';
                const metadata = { name: 'logs.txt', mimeType: contentType };
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    `Content-Type: ${contentType}\r\n\r\n` +
                    logs.map(log => JSON.stringify(log)).join('\n') +
                    closeDelim;

                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${FILE_ID}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: { Authorization: `Bearer ${token}` },
                    body: multipartRequestBody,
                });
                if (!response.ok) throw new Error('Błąd zapisywania logów do Google Drive: ' + response.status);
            } catch (err) {
                console.error('Błąd saveLogs:', err);
            }
        }

        async function logVisit() {
            const ip = await getIp();
            const browser = getBrowser();
            const now = new Date();
            const date = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const time = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });

            const logEntry = { date, time, ip, browser };

            // Ochrona przed DDoS – zapisujemy logi tylko raz na minutę z tego samego IP, chyba że IP się zmieni
            const currentTime = Date.now();
            if (lastIpLogTime[ip]) {
                const timeDiff = (currentTime - lastIpLogTime[ip]) / 1000 / 60; // W minutach
                if (timeDiff < 1 && lastIpLogTime[ip]) {
                    console.log('Ograniczenie logowania – zbyt częste z tego samego IP');
                    return; // Nie zapisujemy, jeśli minęła mniej niż minuta
                }
            }
            lastIpLogTime[ip] = currentTime;

            try {
                let logs = await fetchLogs();
                logs.unshift(logEntry); // Nowe logi na górze
                if (logs.length > 100) logs.pop(); // Usuwamy najstarszy log (ostatni)
                await saveLogs(logs);
                displayLogs(logs);
            } catch (err) {
                console.error('Błąd logVisit:', err);
            }
        }

        function displayLogs(logs) {
            const logTableBody = document.getElementById('logTableBody');
            if (!logTableBody) {
                console.error('Element logTableBody nie istnieje w DOM');
                return;
            }
            logTableBody.innerHTML = '';
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.date || 'Nieznana'}</td>
                    <td>${log.time || 'Nieznana'}</td>
                    <td>${log.ip || 'Nieznany'}</td>
                    <td>${log.browser || 'Nieznana'}</td>
                `;
                logTableBody.appendChild(row);
            });
        }

        // Inicjalizacja przy załadowaniu strony
        window.onload = function() {
            initGoogleAPI();
        };
    </script>
</body>
</html>
